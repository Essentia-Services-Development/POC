mailster=function(e,t,a,i){"use strict";var n={},l=e.$.editbar,r,s={img:0,single:80,multi:0,btn:0,auto:0,codeview:0},o=l.find(".imagepreview"),d=l.find(".imagewidth"),c=l.find(".imageheight"),m=l.find(".imagecrop"),f=l.find(".factor"),h=l.find(".highdpi"),u=l.find(".original"),p=l.find(".imagelink"),g=l.find(".imageurl"),v=l.find(".orgimageurl"),b=l.find(".imagealt"),y=l.find(".singlelink"),_=l.find(".buttonlink"),w=l.find(".buttonlabel"),k=l.find(".buttonalt"),x=l.find(".button-nav"),C=l.find("ul.buttons"),M,A,q,j,T,D,N,E,$,O,z,I,R,H="",W=false,L=t("#post-search"),S=t("#image-search"),B=t('[name="image-search-type"]');l.on("keyup change","input.live",Y).on("keyup change","#mailster-editor",Y).on("click",".replace-image",K).on("change",".highdpi",Q).on("click","button.save",ee).on("click",".cancel",ae).on("click","a.remove",te).on("click","a.reload",de).on("click","a.single-link-content",he).on("click","a.add_image",ge).on("click","a.add_image_url",pe).on("click",".imagelist li",le).on("dblclick",".imagelist li",ee).on("change","#post_type_select input",de).on("click",".postlist li",se).on("click",".load-more-posts",ce).on("click","a.btnsrc",ie).on("click",".imagepreview",ne).on("click","a.nav-tab",F).on("change","select.check-for-posts",G).on("change paste","#dynamic_rss_url",G).on("keyup change","#post-search",fe).on("keyup change","#image-search",fe).on("change",'[name="image-search-type"]',fe).on("mouseenter","#wp-mailster-editor-wrap, .imagelist, .postlist, .CodeMirror",J).on("mouseleave","#wp-mailster-editor-wrap, .imagelist, .postlist, .CodeMirror",V).on("click",".current-tag a",false).on("keypress.mailster",function(e){if(e.keyCode==13&&e.target.nodeName.toLowerCase()!="textarea")return false}).on("keyup.mailster",function(e){switch(e.keyCode){case 27:ae();return false;break;case 13:if(q.type!="multi"&&q.type!="codeview"){ee();return false}break}});t(".imagelist, .postlist").on("scroll",e.util.throttle(me,500));e.util.getRealDimensions(e.$.iframe.contents().find("img").eq(0),function(e,t,a){var i=a>=1.5;f.val(a);h.prop("checked",i);i?l.addClass("high-dpi"):l.removeClass("high-dpi")});x.on("click","a",function(){t(this).parent().find("a").removeClass("nav-tab-active");t(this).parent().parent().find("ul.buttons").hide();var e=t(this).addClass("nav-tab-active").attr("href");t("#tab-"+e.substr(1)).show();return false});g.on("paste change",function(a){var i=t(this);setTimeout(function(){var t=P(i.val()),n=new Image;if(t){Z();n.onload=function(){o.attr("src",t);j={width:q.width||n.width,height:Math.round((q.width||n.width)/(n.width/n.height)),asp:n.width/n.height};c.val(j.height);Z(false)};n.onerror=function(){if(a.type!="paste")alert(e.util.sprintf(e.l10n.campaigns.invalid_image,'"'+t+'"'))};n.src=t}},1)});d.on("keyup change",function(){if(!m.is(":checked"))c.val(Math.round(d.val()/j.asp));re()});c.on("keyup change",function(){if(!m.is(":checked"))d.val(Math.round(c.val()*j.asp));re()});m.on("change",function(){if(!m.is(":checked")){c.val(Math.round(d.val()/j.asp));m.parent().removeClass("not-cropped")}else{m.parent().addClass("not-cropped")}re()});t("#dynamic_embed_options_post_type").on("change",function(){var a=t("#dynamic_embed_options_cats"),i=t(this).val();a.find("select").prop("disabled",true);l.find(".dynamic-rss")[i=="rss"?"show":"hide"]();Z();e.util.ajax("get_post_term_dropdown",{posttype:i},function(i){Z(false);if(i.success){a.html(i.data.html);if(D&&D.terms){var n=a.find(".dynamic_embed_options_taxonomy_wrap");t.each(D.terms,function(a,i){if(!i)return;var l=i.split(",");t.each(l,function(i,l){var r=n.eq(a).find("select").eq(i),s;if(!r.length){s=n.eq(a).find("select").last();r=s.clone();r.insertAfter(s);t("<span> "+e.l10n.campaigns.or+" </span>").insertBefore(r)}r.val(l)})});t.fn.select2&&t("#dynamic_embed_options_cats").find("select").select2()}}G()},function(e,t,a){Z(false)})});e.events.documentReady.push(function(){l.draggable&&l.draggable({distance:20,axis:"y"});if(e.util.isTinyMCE&&tinymce.get("mailster-editor")){if(tinymce.majorVersion>=4){tinymce.get("mailster-editor").on("keyup",function(){ve(this)});tinymce.get("mailster-editor").on("ExecCommand",function(){ve(this)})}else{tinymce.get("mailster-editor").onKeyUp.add(function(){ve(this)});tinymce.get("mailster-editor").onExecCommand.add(function(){ve(this)})}}});function J(){U(false)}function V(){U(true)}function U(e){if(l.draggable){if(e!==false){l.draggable("enable")}else{l.draggable("disable")}}}function F(e,a){var i;if(typeof e=="string"){i=r.find('a[href="'+e+'"]')}else{i=t(this);e=i.attr("href")}i.parent().find("a.nav-tab").removeClass("nav-tab-active");i.addClass("nav-tab-active");r.find(".tab").hide();r.find(e).show();if(e=="#dynamic_embed_options"&&a!==false)t("#dynamic_embed_options_post_type").trigger("change");if(e=="#image_button")A="image";if(e=="#text_button")A="text";E=r.find(e).find(".postlist").eq(0);return false}function K(){Z();var e=f.val(),a=q.element.width(),i=Math.round(a/1.6),n=t("<img>",{src:"https://dummy.mailster.co/"+a*e+"x"+i*e+".jpg",alt:q.content,label:q.content,width:a,height:i,border:0,editable:q.content});n[0].onload=function(){n.attr({width:a,height:i}).removeAttr("style");be()};if(q.element.parent().is("a"))q.element.unwrap();if(!q.element.parent().is("td"))q.element.unwrap();q.element.replaceWith(n);return false}function Q(){if(t(this).is(":checked")){f.val(2);l.addClass("high-dpi")}else{f.val(1);l.removeClass("high-dpi")}}function G(){clearInterval(O);Z();O=setTimeout(function(){var a=l.find("#dynamic_embed_options_post_type").val(),i=l.find("#dynamic_embed_options_content").val(),n=l.find("#dynamic_embed_options_relative").val(),r=l.find(".dynamic_embed_options_taxonomy_wrap"),s=t("#dynamic_rss_url").val(),o={},d=[];t.each(r,function(e){var a=t(this).find("select"),i=[];t.each(a,function(){var e=parseInt(t(this).val(),10);if(e!=-1&&t.inArray(e,i)==-1&&!isNaN(e))i.push(e)});i=i.join(",");if(i)d[e]=i});o={id:e.campaign_id,post_type:a,relative:n,extra:d,content:i,modulename:q.name,expect:q.elements.expects,rss_url:s};if(JSON.stringify(o)===JSON.stringify(z)){Z(false);return}t("#dynamic_embed_options").find("h4.current-match").html("&hellip;");t("#dynamic_embed_options").find("div.current-tag").html("&hellip;");if("rss"==a&&!s){Z(false);return}z=o;e.util.ajax("check_for_posts",o,function(e){Z(false);if(e.success){T=e.data.pattern;t("#dynamic_embed_options").find("h4.current-match").html(e.data.title);t("#dynamic_embed_options").find("div.current-tag").text(e.data.pattern.title+"\n\n"+e.data.pattern[i])}},function(e,t,a){Z(false)})},500)}function P(t,a,i,n,l){a=a||d.val();i=i||c.val()||Math.round(a/1.6);n=typeof n=="undefined"?m.prop(":checked"):n;l=typeof l=="undefined"?u.prop(":checked"):l;if(/^\{(.+)\}$/.test(t)){var r=f.val();t=e.ajaxurl+"?action=mailster_image_placeholder&tag="+t.replace("{","").replace("}","")+"&w="+Math.abs(a)+"&h="+Math.abs(i)+"&c="+(n?1:0)+"&o="+(l?1:0)+"&f="+r}return t}function X(e){if(-1!==e.indexOf("?action=mailster_image_placeholder&tag=")){var t=e.match(/&tag=([a-z0-9-_,;:|~]+)&/);return"{"+t[1]+"}"}return false}function Y(e){if((e.keyCode||e.which)!=27&&q)q.element.html(t(this).val())}function Z(e){if(e===false){t("#editbar-ajax-loading").hide();l.find(".buttons").find("button").prop("disabled",false);W=false}else{W=true;t("#editbar-ajax-loading").css("display","inline");l.find(".buttons").find("button").prop("disabled",true)}}function ee(){if(q.type=="img"){var a=q.element.is("img");if(g.val()){j={id:null,name:"",src:P(g.val()),width:j.width,height:j.height,asp:j.width/j.height}}if(j){Z();var i=f.val()||1,n=d.val(),s=c.val(),h=m.is(":checked"),x=u.is(":checked"),C=a?"src":"background",D;q.element.attr({"data-id":j.id}).data("id",j.id).addClass("mailster-loading");if(a){q.element.attr({src:j.src,alt:j.name});if(!q.is_percentage){q.element.attr("width",Math.round(n))}if(q.element.attr("height")&&q.element.attr("height")!="auto"){q.element.attr("height",Math.round(s))}if(h){q.element.attr({"data-crop":true}).data("crop",true)}if(x){q.element.attr({"data-original":true}).data("original",true)}}if(j.src){q.element.attr(C,j.src);if(D=q.element.attr("style")){q.element.attr("style",D.replace(/url\("?(.+)"?\)/,"url('"+j.src+"')"))}}e.util.ajax("create_image",{id:j.id,original:x,src:j.src,width:n*i,height:s*i,crop:h},function(t){Z(false);if(t.success){o.attr("src",t.data.image.url);t.data.image.width=(t.data.image.width||j.width)/i;t.data.image.height=t.data.image.width/j.asp;t.data.image.asp=j.asp;j=t.data.image;j.name=b.val();if(a){q.element.one("load error",function(a){if("error"==a.type){alert(e.util.sprintf(e.l10n.campaigns.invalid_image,t.data.image.url))}q.element.removeClass("mailster-loading");e.trigger("save")});q.element.attr({alt:j.name});if(!q.is_percentage){q.element.attr("width",Math.round(d.val()))}if(q.element.attr("height")&&q.element.attr("height")!="auto"){q.element.attr("height",Math.round(c.val()))}if(h){q.element.attr({"data-crop":true}).data("crop",true)}if(x){q.element.attr({"data-original":true}).data("original",true)}}else{q.element.removeClass("mailster-loading");var n=q.element.html(),l=n.match(/<modules/),r;if(v.val()){if(l){if(l=n.match(new RegExp("<v:background(.*)</v:background>","s"))){q.element.html(e.util.replace(n,l[0],e.util.replace(l[0],v.val(),j.url)))}}else{q.element.html(e.util.replace(n,v.val(),j.url));q.element.find("single, multi").removeAttr("id")}}}q.element.removeAttr(C).attr(C,j.url)}else{q.element.removeClass("mailster-loading")}b.val("");be()},function(e,t,a){Z(false)})}else{q.element.attr({alt:b.val()});be()}if(q.element.parent().is("a"))q.element.unwrap();var N=p.val();if(N)q.element.wrap('<a href="'+N+'"></a>');return false}else if(q.type=="btn"){var N=_.val();if(!N&&!confirm(e.l10n.campaigns.remove_btn))return false;var E=r.find("a.active").find("img").attr("src");if(typeof E=="undefined"){A="text";if(!w.val())w.val(e.l10n.campaigns.read_more)}q.element.removeAttr("tmpbutton");if("image"==A){var i=f.val();var $=new Image;$.onload=function(){if(!q.element.find("img").length){var e=q.element.closest(".textbutton");var a=t('<a href="" editable label="'+q.name+'"><img></a>');e.length?e.replaceWith(a):q.element.replaceWith(a);q.element=a}q.element.find("img").attr({src:E,width:Math.round(($.width||q.element.width())/i),height:Math.round(($.height||q.element.height())/i),alt:k.val()});N?q.element.attr("href",N):q.element.remove();be()};$.src=E}else{var O=q.element.closest(".textbutton"),z=w.val();if(!O.length){q.element.replaceWith('<table class="textbutton" align="left" role="presentation"><tr><td align="center" width="auto"><a href="'+N+'" editable label="'+z+'">'+z+"</a></td></tr></table>")}else{if(q.element[0]==O[0]){q.element=O.find("a")}q.element.text(z)}if(N){q.element.attr("href",N)}else{q.element.remove();O.remove()}be()}return false}else if(q.type=="auto"){var I=t("#embedoption-bar").find(".nav-tab-active").data("type"),R=q.element.data("position")||0,H,W=[],L,S;q.element.removeAttr("data-tag data-rss").removeData("tag").removeData("data-rss");if("dynamic"==I){H=l.find("#dynamic_embed_options_content").val();L=l.find("#dynamic_embed_options_post_type").val();S=t("#dynamic_rss_url").val();T.content=T[H];q.element.attr("data-tag",T.tag).data("tag",T.tag);if("rss"==L){q.element.attr("data-rss",S).data("rss",S)}}else{H=t(".embed_options_content:checked").val();q.element.removeAttr("data-tag").removeData("tag")}if(T){if(q.elements.single.length){q.elements.single.each(function(e,a){var i=t(this),n=i.attr("expect")||"title",l=T[n]?T[n]:"";if(t.isArray(l))l=l[e];if(l&&!i.is("[ignore]"))i.html(l)})}if(q.elements.multi.length){q.elements.multi.each(function(e,a){var i=t(this),n=i.attr("expect")||H,l=T[n]?T[n]:"";if(t.isArray(l))l=l[e];if(l&&!i.is("[ignore]"))i.html(l)})}if(T.link){q.elements.buttons.each(function(e,a){var i=t(this),n=i.attr("expect")||"link",l=T[n]?T[n]:"";if(i.is("[ignore]"))return;if(l)i.attr("href",l);if(T["button"])i.html(T["button"])})}else{if(q.elements.buttons.parent().length&&q.elements.buttons.parent()[0].nodeName=="TD"){q.elements.buttons.closest(".textbutton").remove()}else if(q.elements.buttons.length){if(q.elements.buttons.last().find("img").length){q.elements.buttons.remove()}}}if(T.image&&q.elements.images.length){Z();q.elements.images.each(function(a,i){var n=t(this),l=f.val();if("static"==I){T.image.id&&e.util.ajax("create_image",{id:T.image.id,original:u.is(":checked"),width:n.width()*l,height:n.height()*l,crop:n.data("crop")},function(t){if(t.success){Z(false);if(u.is(":checked")){n.attr("data-original",true).data("original",true)}if("img"==n.prop("tagName").toLowerCase()){n.attr({"data-id":T.image.id,src:t.data.image.url,width:Math.round(t.data.image.width/l),alt:T.alt||T.title}).data("id",T.image.id);if(n.attr("height")&&n.attr("height")!="auto"){n.attr("height",Math.round(t.data.image.height/l))}if(n.parent().is("a")){n.unwrap()}if(T.link){n.wrap('<a href="'+T.link+'">')}}else{var a=n.attr("background");n.attr({"data-id":T.image.id,background:t.data.image.url}).data("id",T.image.id);q.element.html(e.util.replace(q.element.html(),a,t.data.image.url));q.element.find("single, multi").removeAttr("id");e.trigger("save");e.trigger("refresh")}}},function(e,t,a){Z(false)});return false}else if("dynamic"==I){var r=n.width(),s=n.data("crop"),o=u.is(":checked"),d=s?n.height():null;if("img"==n.prop("tagName").toLowerCase()){n.removeAttr("data-id").attr({src:P(T.image,r,d,s,o),width:r,alt:T.alt||T.title}).removeData("id");if(n.attr("height")){n.attr("height",d||Math.round(r/1.6))}}else{var c=n.attr("background");n.removeAttr("data-id").attr({background:P(T.image,r)}).removeData("id");q.element.html(e.util.replace(q.element.html(),c,P(T.image,r,d,s,o)));q.element.find("single, multi").removeAttr("id")}}})}R=R+1>=q.areas.length?0:R+1;q.element.data("position",R);e.$.iframe.contents().find("html").find("img").each(function(){this.onload=function(){e.trigger("refresh")}})}}else if(q.type=="multi"){if(e.util.isTinyMCE&&tinymce.get("mailster-editor")&&!tinymce.get("mailster-editor").isHidden()){var B=tinymce.get("mailster-editor").getContent();B=B.replace('href="http://{','href="{');q.element.html(B)}}else if(q.type=="single"){if(q.conditions){q.aa="<if";t.each(t(".conditinal-area"),function(){q.aa=""})}if(q.element.parent().is("a"))q.element.unwrap();var N=y.val();if(N)q.element.wrap('<a href="'+N+'"></a>')}else if(q.type=="codeview"){var J=M.codemirror.getValue();q.element.html(J);q.modulebuttons.prependTo(q.element)}be();return false}function te(){if(q.element.parent().is("a"))q.element.unwrap();if("btn"==q.type){var e=q.element.closest(".textbutton"),t=e.parent();if(!e.length){e=q.element}if(t.is("buttons")&&!t.find(".textbutton").length){t.remove()}else{e.remove()}}else if("img"==q.type&&"img"!=q.tag){q.element.attr("background","")}else{q.element.remove()}be();return false}function ae(){switch(q.type){case"img":case"btn":if(q.element.is("[tmpbutton]")){q.element.remove()}break;default:q.element.html(q.content);q.element.find("single, multi").removeAttr("id")}be();return false}function ie(){var e=t(this),a=e.data("link");r.find(".btnsrc").removeClass("active");e.addClass("active");k.val(e.attr("title"));if(a){var i;_.val(a);if((i=(a+"").indexOf("USERNAME",0))!=-1){_.focus();selectRange(_[0],i,i+8)}}return false}function ne(){t(this).toggleClass("zoom")}function le(e,a){var i=a||t(this),n=i.data("id"),l=i.data("name"),s=i.data("src");if(!n)return;j={id:n,name:l,src:s};Z();r.find("li.selected").removeClass("selected");i.addClass("selected");if(q.element.data("id")==n){b.val(q.element.attr("alt"))}else if(q.element.attr("alt")!=l){b.val(l)}g.val("");o.attr("src","").on("load",function(){o.off("load");q.width=o.width();q.height=o.height();q.asp=i.data("asp")||q.width/q.height;j.asp=q.asp;Z(false);if(!m.is(":checked"))c.val(Math.round(d.val()/q.asp));re()}).attr("src",s);return j}function re(){var e=Math.round(.5*(q.height-q.width*(c.val()/d.val())))||0,t=parseInt(f.val(),10);o.css({clip:"rect("+e+"px,"+q.width*t+"px,"+(q.height*t-e)+"px,0px)","margin-top":-1*e+"px"})}function se(){var a=t(this),i=a.data("id"),n=a.data("name"),l=a.data("link"),s=a.data("thumbid");if(q.type=="btn"){_.val(l);k.val(n);r.find("li.selected").removeClass("selected");a.addClass("selected")}else if(q.type=="single"){y.val(l);r.find("li.selected").removeClass("selected");a.addClass("selected")}else{Z();e.util.ajax("get_post",{id:i,expect:q.elements.expects},function(t){Z(false);r.find("li.selected").removeClass("selected");a.addClass("selected");if(t.success){T=t.data.pattern;r.find(".editbarinfo").html(e.l10n.campaigns.curr_selected+": <span>"+T.title+"</span>")}},function(e,t,a){Z(false);r.find("li.selected").removeClass("selected")})}return false}function oe(i){q=i;var n=i.element,s=n.closest("module"),C=T!="img"?i.offset.top:0,A=i.name||"",T=i.type,$=e.util.trim(n.html()),O=n.find("if"),z,I=q.element.data("position")||0,R,W,B,J=1;r=l.find("div.type."+T);l.addClass("current-"+T);q.width=n.width();q.height=n.height();q.asp=q.width/q.height;q.crop=n.data("crop")?n.data("crop"):false;q.tag=n.prop("tagName").toLowerCase();q.is_percentage=n.attr("width")&&n.attr("width").indexOf("%")!==-1;q.content=$;D=q.element.data("tag");H="";e.trigger("selectModule",s);if(O.length){z={if:null,elseif:[],else:null,total:0};z=[];l.addClass("has-conditions");R=r.find(".conditinal-area");W=l.find(".conditions").eq(0);W.clone().prependTo(R);t.each(O.find("elseif"),function(){var e=t(this),a=e.html();z.push({el:e,html:a,field:e.attr("field"),operator:e.attr("operator"),value:e.attr("value")});e.detach();R.clone().val(a).insertAfter(R)});t.each(O.find("else"),function(){var e=t(this),a=e.html();z.push({el:e,html:a});e.detach();R.clone().val(a).insertAfter(R)});z.unshift({el:O,html:O.html(),field:O.attr("field"),operator:O.attr("operator"),value:O.attr("value")})}else{l.removeClass("has-conditions")}q.conditions=z;if(T=="img"){u.prop("checked",q.original);m.prop("checked",q.crop).parent()[q.crop?"addClass":"removeClass"]("not-cropped");H=e.util.trim(S.val());f.val(1);e.util.getRealDimensions(n,function(e,t,a){var t=a>=1.5;f.val(a);h.prop("checked",t);t?l.addClass("high-dpi"):l.removeClass("high-dpi");J=a})}else if(T=="btn"){if(n.find("img").length){t("#button-type-bar").find("a").eq(1).trigger("click");var V=n.find("img").attr("src");if(x.length){var U=l.find("img[src='"+V+"']");if(U.length){l.find("ul.buttons").hide();var K=U.parent().parent().parent();l.find('a[href="#'+K.attr("id").substr(4)+'"]').trigger("click")}else{t.each(l.find(".button-nav"),function(){t(this).find(".nav-tab").eq(0).trigger("click")})}}w.val(n.find("img").attr("alt"));e.util.getRealDimensions(n.find("img"),function(e,t,a){var t=a>=1.5;f.val(a);h.prop("checked",t);t?l.addClass("high-dpi"):l.removeClass("high-dpi");J=a})}else{t("#button-type-bar").find("a").eq(0).trigger("click");w.val(e.util.trim(n.text())).focus().select();_.val(q.element.attr("href"));l.find("ul.buttons").hide()}}else if(T=="auto"){F("#"+(D?"dynamic":"static")+"_embed_options",true);H=e.util.trim(L.val());if(D){var Q=D.substr(1,D.length-2).split(":"),G=Q[1].split(";"),P=G.shift(),Y=G.length?G:null;D={post_type:Q[0],relative:P,terms:Y};t("#dynamic_embed_options_post_type").val(D.post_type).trigger("change");t("#dynamic_embed_options_relative").val(D.relative).trigger("change")}else{}}else if(T=="codeview"){var ee=r.find("textarea"),te=n.clone();q.modulebuttons=te.find("modulebuttons");te.find("modulebuttons").remove();te.find("single, multi").removeAttr("contenteditable spellcheck id dir style class");var ae=e.util.trim(te.html().replace(/\u200c/g,"&zwnj;").replace(/\u200d/g,"&zwj;"));ee.show().html(ae)}B=e.$.template.offset().top+(q.offset.top-e.$.window.height()/2+q.height/2);B=Math.max(e.$.template.offset().top-200,B);e.util.scroll(B,function(){l.find("h4.editbar-title").html(A);l.find("div.type").hide();l.find("div."+T).show();if(s.data("rss"))t("#dynamic_rss_url").val(s.data("rss"));var i=e.util.top()+e.$.window.height()/2-e.$.template.offset().top-l.height()/2;l.css({top:i});Z();if(T=="single"){if(z){t.each(z,function(e,t){var a=r.find(".conditinal-area").eq(e);a.find("select.condition-fields").val(t.field);a.find("select.condition-operators").val(t.operator);a.find("input.condition-value").val(t.value);a.find("input.input").val(t.html)})}else{var f=$.replace(/&amp;/g,"&");y.val("");if(q.element.parent().is("a")){var h=q.element.parent().attr("href");y.val(h!="#"?h:"");he()}else if(q.element.find("a").length){var u=q.element.find("a");if(f==u.text()){var h=u.attr("href");f=u.text();y.val(h!="#"?h:"")}}r.find("input").eq(0).val(e.util.trim(f))}}else if(T=="img"){var w=parseInt(n[0].style.maxWidth,10)||n.parent().width()||n.width()||null;var x=parseInt(n[0].style.maxHeight,10)||n.parent().height()||n.height()||null;var C=n.attr("src")||n.attr("background");var D=X(C)||"";if(n.parent().is("a")){p.val(n.parent().attr("href").replace("%7B","{").replace("%7D","}"))}else{p.val("")}b.val(n.attr("alt"));g.val(D);v.val(C);n.data("id",n.attr("data-id"));t(".imageurl-popup").toggle(!!D);o.removeAttr("src").attr("src",C);N="attachment";E=r.find(".imagelist");j={id:n.data("id"),src:C,width:n.width()*J,height:n.height()*J};j.asp=j.width/j.height;de();re()}else if(T=="btn"){k.val(n.find("img").attr("alt"));if(n.attr("href"))_.val(n.attr("href").replace("%7B","{").replace("%7D","}"));N="link";E=r.find(".postlist").eq(0);de();t.each(r.find(".buttons img"),function(){var e=t(this);e.css("background-color",n.css("background-color"));e.attr("src")==V?e.parent().addClass("active"):e.parent().removeClass("active")})}else if(T=="auto"){N="post";E=r.find(".postlist").eq(0);de();q.areas=q.element.find("[area]");if(!q.areas.length){q.areas=q.element}q.elements={single:q.areas.eq(I).find("single"),multi:q.areas.eq(I).find("multi"),buttons:q.areas.eq(I).find("a[editable]"),images:q.areas.eq(I).find("img[editable], td[background], th[background]"),expects:q.areas.eq(I).find("[expect]").map(function(){return t(this).attr("expect")}).toArray()};if(q.areas.length>1){l.find(".editbarposition").html(e.util.sprintf(e.l10n.campaigns.for_area,"#"+(I+1))).show()}else{l.find(".editbarposition").hide()}}else if(T=="codeview"){if(M){M.codemirror.clearHistory();M.codemirror.setValue("");r.find(".CodeMirror").remove()}}l.show(0,function(){if(T=="single"){l.find("input").focus().select()}else if(T=="img"){d.val(Math.round(q.width));c.val(Math.round(q.height));m.prop("checked",q.crop)}else if(T=="btn"){d.val(Math.round(w));c.val(Math.round(x))}else if(T=="multi"){t("#mailster-editor").val($);if(e.util.isTinyMCE&&tinymce.get("mailster-editor")){tinymce.get("mailster-editor").setContent($);tinymce.execCommand("mceFocus",false,"mailster-editor")}}else if(T=="codeview"){if(wp.codeEditor){M=wp.codeEditor.initialize(ee,{codemirror:e.util.codemirrorargs})}else{M={codemirror:a.CodeMirror.fromTextArea(ee.get(0),e.util.codemirrorargs)}}}});Z(false)},100)}function de(a,i){var n=t("#post_type_select").find("input:checked").serialize(),l={type:N,posttypes:n,search:H,imagetype:B.filter(":checked").val(),offset:0};if(N=="attachment"){l.id=j.id}E.empty();Z();e.util.ajax("get_post_list",l,function(e){Z(false);if(e.success){$=e.data.itemcount;ue(e.data.html,true);i&&i()}},function(e,t,a){Z(false)})}function ce(){var a=t(this),i=a.data("offset"),n=a.data("type");Z();var l=t("#post_type_select").find("input:checked").serialize();e.util.ajax("get_post_list",{type:n,posttypes:l,search:H,imagetype:B.filter(":checked").val(),offset:i,itemcount:$},function(e){Z(false);if(e.success){$=e.data.itemcount;a.remove();ue(e.data.html,false)}},function(e,t,a){Z(false)});return false}function me(){var e=t(this);var a=e.scrollTop();var i=e.innerHeight();var n=this.scrollHeight;if(!W&&a+i>=n-15){e.find(".load-more-posts").click()}}function fe(){var a=t(this),i=e.util.trim("attachment"==N?S.val():L.val());if(!a.is(":checked")&&H==i){return false}H=i;clearTimeout(I);I=setTimeout(function(){de()},500)}function he(){t("#single-link").slideDown(200);y.focus().select();N="link";E=r.find(".postlist").eq(0);de();return false}function ue(e,t,a){if(!a)a=E;if(t)a.empty();if(!a.html())a.html("<ul></ul>");a.find("ul").append(e)}function pe(){t(".imageurl-popup").toggle();if(!g.val()&&j.src.indexOf(location.origin)==-1&&j.src.indexOf("dummy.mailster.co")==-1){g.val(j.src)}g.focus().select();return false}function ge(){if(!wp.media.frames.mailster_editbar){wp.media.frames.mailster_editbar=wp.media({title:e.l10n.campaigns.select_image,library:{type:"image"},multiple:false});wp.media.frames.mailster_editbar.on("select",function(){var e=wp.media.frames.mailster_editbar.state().get("selection").first().toJSON(),a=t("img").data({id:e.id,name:e.name,src:e.url});de(null,function(){le(null,a)})})}wp.media.frames.mailster_editbar.open()}function ve(t){clearTimeout(timeout);timeout=setTimeout(function(){if(!t)return;var a=e.util.trim(t.save());q.element.html(a)},100)}function be(){l.removeClass("current-"+q.type).hide();Z(false);t("#single-link").hide();e.trigger("refresh");e.trigger("save");return false}n.save=ee;n.open=oe;n.cancel=ae;e.editbar=n;return e}(mailster||{},jQuery,window,document);