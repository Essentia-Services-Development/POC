!function(t){e="PsActivityStream",r=t,n=peepso.ajax,t=peepso.observer,peepso.modules,i="scroll.ps-activity-stream",a=+peepsodata.is_admin,l=+peepsodata.currentuserid,d=+peepsodata.userid,p=r("#peepso_post_id").val()||void 0,c=r("#peepso_context").val()||void 0,function(t,e){function i(){t.clientWidth<700?t.classList.add("ps-activity--narrow"):t.classList.remove("ps-activity--narrow")}t&&(i(),e.addAction("browser.resize",i))}(document.querySelector(".ps-activity"),t);var e,r,n,i,a,l,d,p,c,s=peepso.createClass(e,{__constructor:function(t,e){this.$el=r(t),this.$recent=r("#ps-activitystream-recent"),this.$loading=r("#ps-activitystream-loading"),this.$noPosts=r("#ps-no-posts"),this.$noPostsMatch=r("#ps-no-posts-match"),this.$noMorePosts=r("#ps-no-more-posts"),this.$filters=r(".ps-js-activitystream-filter"),this.$filtersToggle=r(".ps-js-activitystream-filters-toggle"),this.$filtersWrapper=r(".ps-js-activitystream-filters-wrapper"),this.loading=!1,this.loadEnd=!1,this.loadPage=1,this.loadIds=[],this.loadLimit=+peepsodata.activity_limit_below_fold;var t=+peepsodata.loadmore_enable,t=peepso.isMobile()?1===t||2===t:1===t||3===t,i=(this.loadButtonEnabled=t,this.loadButtonRepeat=this.loadButtonEnabled?+peepsodata.loadmore_repeat:0,this.loadButtonTemplate=e.template_load_more,this.isPermalink=+e.is_permalink,this.hideFromGuest=+e.hide_from_guest,this.loadLimit=0<this.loadLimit?this.loadLimit:3,r.proxy(function(t){var e,i,s;t&&(t="core_"+t,e=r("[id=peepso_stream_id]"),i=(s=this.$filters.filter("[data-id=peepso_stream_id]")).find('[data-option-value="'+t+'"]'),s=s.find(".ps-js-dropdown-toggle"),e.val()!==t&&i.length&&(e.val(t),s.find("span").text(i.find("span").text()),s.find(".ps-js-icon").attr("class",i.find(".ps-js-icon").attr("class"))))},this)(window.location.hash.slice(1)),this.$filterNotice=r("#ps-stream__filters-warning"),this.$filterNotice.length&&this.$filterNotice.data("html",this.$filterNotice.html().trim()),this.filterNoticeMap={},this.$filters.filter("[data-id=peepso_stream_id]").find("[data-option-value]").each(r.proxy(function(t,e){var e=r(e),i=e.data("option-value"),e=e.data("option-label-warning");this.filterNoticeMap[i]=e},this)),this.streamData={},r("[id^=peepso_stream_]").each(r.proxy(function(t,e){var i=e.id.replace(/^peepso_/,""),e=e.value;this.streamData[i]=e,"stream_id"===i&&(a||"core_scheduled"!==e?this.allowHideMyPosts(!0):this.allowHideMyPosts(!1))},this)),r(document).on("peepso_login_shown",function(){this.$loading.hide()}.bind(this)),this.$filters.on("click",".ps-js-dropdown-toggle",r.proxy(this.onFilterToggle,this)),this.$filters.on("click","[data-option-value]",r.proxy(this.onFilterSelect,this)),this.$filters.on("click",".ps-js-cancel",r.proxy(this.onFilterCancel,this)),this.$filters.on("click",".ps-js-apply",r.proxy(this.onFilterApply,this)),this.$filters.on("click","[type=text]",r.proxy(this.onFilterFocus,this)),this.$filters.on("keyup","[type=text]",r.proxy(this.onFilterKeyup,this)),this.$filters.on("click",".ps-js-search",r.proxy(this.onFilterSearch,this)),this.$filtersToggle.on("click",r.proxy(this.onFiltersToggle,this)),this.loadEverything="#everything"===window.location.hash,!this.loadEverything||confirm("Are you sure want to load every post?")||(this.loadEverything=!1),peepso.observer.addFilter("show_more_posts",t=>{let e=window.location.search||"";return e.match("peepso_remote_no_cache")&&(t.peepso_remote_no_cache=1),t}),r("#ps-activitystream-search"));this.search(i.eq(0).val()),peepso.observer.addAction("peepso_stream_reset",r.proxy(function(){this.search(i.eq(0).val())},this)),peepso.observer.addFilter("post_saved_notice",r.proxy(function(t){return t="core_saved"===this.streamData.stream_id?!1:t},this),10,1)},search:function(t){var e,i;t=(t||"").trim(),this.searchKeyword=t,this.searchMode="exact",this.reset(),(e=r(".ps-js-activitystream-filter").filter("[data-id=peepso_search]").find(".ps-js-dropdown-toggle").find("span")).length&&(t?(i=e.data("keyword"),i+=t+'<i class="ps-posts__filter-remove gcis gci-times-circle"></i>',e.one("click","i",r.proxy(function(t){r("#ps-activitystream-search").val(""),this.search("")},this))):i=e.data("empty"),e.html(i))},autoload:function(e){var t;if(e===this._token&&!this.loading)return!l&&this.hideFromGuest?(this.$loading.hide(),!1):void(this.shouldLoad()?(this.loading=!0,this.load(e).done(r.proxy(function(){this.loading=!1,this.isPermalink||this.loadEnd||this.autoload(e)},this))):this.loadButtonEnabled&&!this.$loadButton?(this.$loadButton=r(this.loadButtonTemplate).insertAfter(this.$el),this.$loadButton.one("click",r.proxy(function(t){r(t.currentTarget).remove(),this.autoload(e)},this))):this._onScrollEnabled||(t=peepso.observer.applyFilters("activitystream_scrollable_container",window),this._onScrollEnabled=!0,r(t).on(i,e,r.proxy(this.onScroll,this))))},shouldLoad:function(){var t,e=this.$el.children(".ps-js-activity");return!this.loadEnd&&(!e.length||(!!this.loadEverything||(this.loadButtonEnabled&&this.loadButtonRepeat?e.length%this.loadButtonRepeat!=0||!!this.$loadButton&&(delete this.$loadButton,!0):!!(e=e.slice(0-this.loadLimit).eq(0)).length&&(e=this.loadButtonEnabled&&!this.$loadButton?e.eq(0).offset():e[0].getBoundingClientRect(),t=window.innerHeight||document.documentElement.clientHeight,e.top<t))))},load:function(s){var o=this,a=_.extend({uid:l,user_id:d,post_id:p,context:c,page:this.loadPage,search:this.searchKeyword||void 0,search_mode:this.searchKeyword&&this.searchMode||void 0,pinned:1===this.loadPage?1:void 0},this.streamData||{}),a=peepso.observer.applyFilters("show_more_posts",a);return r.Deferred(function(i){o.$loading.show(),n.post("activity.show_posts_per_page",a).done(function(t){var e;s===o._token&&(o.$loading.hide(),0<t.data.found_posts?((e=+t.data.act_id)?-1===o.loadIds.indexOf(e)&&(o.loadIds.push(e),o.render(t.data.posts)):o.render(t.data.posts),o.loadPage++):o.loadEnd=!0,o.loadEnd&&(1<a.page?((e=peepso.observer.applyFilters("activitystream_pending_html",""))&&o.render(e),o.$noMorePosts):o.searchKeyword?o.$noPostsMatch:o.$noPosts).show(),i.resolve())})})},reset:function(){this.loading=!1,this.loadEnd=!1,this.loadPage=1,this.loadIds=[];var t=peepso.observer.applyFilters("activitystream_scrollable_container",window),t=(this._onScrollEnabled=!1,r(t).off(i),this.$loadButton&&(this.$loadButton.remove(),this.$loadButton=void 0),this.$el.empty().hide(),this.$recent.empty(),this.$noMorePosts.hide(),this.$noPosts.hide(),this.$noPostsMatch.hide(),this.filterNoticeMap[this.streamData.stream_id]);t?(this.$filterNotice.html(this.$filterNotice.data("html").replace("%s",t)),this.$filterNotice.show()):this.$filterNotice.hide(),this._token=(new Date).getTime(),this.autoload(this._token),this.updateFilterIcons()},render:function(t){t=(t=t.replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)*"/g,'/?embed=true$1"')).replace(/\/\?embed=true([#"])/g,"/?embed=true&peepso=1$1");var e=r(t),s=this.searchKeyword,o=this.searchMode;(e=peepso.observer.applyFilters("peepso_activity",e)).find(".ps-js-activity-content, .ps-js-activity-quote, .ps-comment-item").each(function(){var t=r(this),e=t.html(),e=peepso.observer.applyFilters("peepso_activity_content",e);t.html(e)}),s&&e.find(".ps-js-activity-content").each(function(){var t=r(this),e=t.html(),i=[s];"any"===o&&(i=_.filter(s.split(" "),function(t){return t})),i=_.map(i,function(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}),i=RegExp("("+i.join("|")+")(?![^<>]+>)","ig"),e=e.replace(i,'<span class="ps-text--highlight">$1</span>'),t.html(e)}),this.$el.is(":hidden")&&this.$el.show();try{e.appendTo(this.$el),e.each(function(){peepso.hooks.doAction("post_added",this)})}catch(t){}e.hide().fadeIn(1e3,function(){r(document).trigger("ps_activitystream_loaded"),peepso.observer.doAction("post_loaded",this),t.match(/\sdata-instgrm-permalink/)&&setTimeout(function(){try{window.instgrm.Embeds.process()}catch(t){}},1e3)})},allowHideMyPosts:function(t){var e="stream_filter_show_my_posts",i=this.$filters.filter(`[data-id=peepso_${e}]`),s=i.find(".ps-js-dropdown-toggle");t?s.show():(s.hide(),(t=i.find("[data-option-value]")).find("[type=radio][value=show_mine]").prop("checked",!0),t.find("[type=radio][value=hide_mine]").prop("checked",!1),i=t.find("[type=radio]:checked").val(),r("#peepso_"+e).val(i),this.streamData[e]=i,e=t.filter("[data-option-value=show_mine]"),s.find("span").text(e.find("span").text()),s.find('[class*="ps-icon-"]').attr("class",e.find('[class*="ps-icon-"]').attr("class")))},updateFilterIcons:function(){var i=this.$filtersToggle.children("span").empty();this.$filtersWrapper.children("input[type=hidden]").each(function(){var t=r(this).next(`[data-id="${this.id}"]`),e=t.children(".ps-js-dropdown-toggle"),t=t.find(`[data-option-value="${this.value}"]`).find(".ps-js-icon");e.find(".ps-js-icon").replaceWith(t.clone()),i.append(t.clone())})},onScroll:_.throttle(function(t){t=t.data;this.autoload(t)},1),onFilterToggle:_.debounce(function(t){var t=r(t.currentTarget),e=t.closest(".ps-js-activitystream-filter"),i=e.find(".ps-js-dropdown-menu"),s=e.data("id").replace(/^peepso_/,""),s=this.streamData[s];e.is(":visible")&&(e=e.find("[type=radio]").filter('[value="'+s+'"]')).length&&(e[0].checked=!0),this.$filtersWrapper.find(".ps-js-dropdown-toggle").removeClass("ps-posts__filter-toggle--active"),i.is(":visible")&&t.addClass("ps-posts__filter-toggle--active")},1),onFilterSelect:function(t){var e=r(t.currentTarget).find("[type=radio]");t.preventDefault(),t.stopPropagation(),_.defer(function(){e[0].checked=!0})},onFilterCancel:function(t){t=r(t.currentTarget).closest(".ps-js-activitystream-filter").find(".ps-js-dropdown-toggle");t.removeClass("ps-posts__filter-toggle--active"),t.focus()},onFilterApply:function(t){var t=r(t.currentTarget).closest(".ps-js-activitystream-filter"),e=t.find(".ps-js-dropdown-toggle"),i=r("#"+t.data("id")),s=t.find("[type=radio]:checked").closest("[data-option-value]"),o=s.data("optionValue"),t=t.data("id").replace(/^peepso_/,"");i.val(o),this.streamData[t]=o,e.find("span").text(s.find("span").text()),e.find(".ps-js-icon").attr("class",s.find(".ps-js-icon").attr("class")),e.removeClass("ps-posts__filter-toggle--active"),e.focus(),"stream_id"===t&&(a||"core_scheduled"!==o?this.allowHideMyPosts(!0):this.allowHideMyPosts(!1)),this.reset()},onFilterFocus:function(t){t.stopPropagation()},onFilterKeyup:function(t){t.stopPropagation(),13===t.which&&r(t.currentTarget).closest(".ps-js-activitystream-filter").find(".ps-js-search").click()},onFilterSearch:function(t){var t=r(t.currentTarget).closest(".ps-js-activitystream-filter"),e=t.find(".ps-js-dropdown-toggle"),i=r("#"+t.data("id")),s=t.find("[type=radio]:checked").closest("[data-option-value]"),o=t.find("[type=text]"),s=s.data("optionValue"),t=(t.data("id").replace(/^peepso_/,""),o.val().trim()),o=e.find("span").data(t?"keyword":"empty");i.val(s),this.searchKeyword=t,this.searchMode=s,o=t?(o=e.find("span").data("keyword"))+t+'<i class="ps-posts__filter-remove gcis gci-times-circle"></i>':e.find("span").data("empty"),e.find("span").html(o).off("click","i").one("click","i",r.proxy(function(t){var e=r(t.target).closest(".ps-js-dropdown-toggle"),i=e.closest(".ps-js-activitystream-filter"),s=i.find("[type=text]"),i=r("#"+i.data("id"));t.stopPropagation(),s.val(""),i.val(""),e.find("span").html(e.find("span").data("empty")),this.searchKeyword="",this.searchMode="",this.reset()},this)),e.focus(),this.reset()},onFiltersToggle:function(t){this.$filtersWrapper.is(":visible")?(this.$filtersWrapper.hide(),this.$filtersToggle.removeClass("ps-posts__filters-toggle--active")):(this.$filtersWrapper.show(),this.$filtersToggle.addClass("ps-posts__filters-toggle--active"))}});jQuery(function(t){var e,t=t("#ps-activitystream");t.length&&(e=peepsodata&&peepsodata.activity||{},new s(t[0],e))})}((window,jQuery));